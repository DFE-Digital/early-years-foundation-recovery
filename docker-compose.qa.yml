# ------------------------------------------------------------------------------
---
services:
  app:
    command: rails server -b 'ssl://0.0.0.0:3000?key=localhost.key&cert=localhost.crt'
    healthcheck:
      test: curl --fail --insecure https://app:3000/health || exit 1
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/early_years_foundation_recovery_production
      - RAILS_SERVE_STATIC_FILES=true
    ports:
      - 3000:3000
    volumes:
      # NB: or ensure RAILS_MASTER_KEY=<production master key> is in .env
      - ./config/credentials/production.key:/src/config/credentials/production.key
      # NB: run ./bin/docker-certs to generate a self-signed certificate
      - ./localhost.key:/src/localhost.key
      - ./localhost.crt:/src/localhost.crt

  qa:
    container_name: recovery_qa
    build:
      context: .
      target: qa
    image: recovery:qa
    environment:
      - BASE_URL
      - BROWSER
    depends_on:
      app:
        condition: service_healthy
      chrome:
        condition: service_healthy
      firefox:
        condition: service_healthy
    networks:
      - recovery
    tty: true
    stdin_open: true

  chrome:
    container_name: recovery_chrome
    image: selenium/standalone-chrome:latest
    healthcheck:
      test: curl --fail http://chrome:4444 || exit 1
    networks:
      - recovery

  firefox:
    container_name: recovery_firefox
    image: selenium/standalone-firefox:latest
    healthcheck:
      test: curl --fail http://firefox:4444 || exit 1
    networks:
      - recovery
